<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FBLACER</title>
    <!-- Load a clean, versatile UI font (Inter) from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <!-- Chart.js removed: replaced by aleks-chart.js -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyCG32qVhboeAYBGYcq9QniwBeiAVMHFvo4",
        authDomain: "fblacer.firebaseapp.com",
        projectId: "fblacer",
        storageBucket: "fblacer.firebasestorage.app",
        messagingSenderId: "410096026599",
        appId: "1:410096026599:web:3d484f1d2d961180e7b342",
        measurementId: "G-C79TMGDW0Q",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      // Firestore imports and a tiny wrapper API for leaderboard operations
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        getDocs,
        where,
        serverTimestamp,
        doc,
        setDoc,
        getDoc,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      const db = getFirestore(app);

      // Initialize Auth and sign in anonymously so Firestore rules that require auth pass.
      const auth = getAuth(app);
      // Initialize Auth and prefer persistent login across refreshes.
      try {
        // prefer browser local persistence
        setPersistence(auth, browserLocalPersistence).catch((err) => {
          console.warn("setPersistence failed", err);
        });
      } catch (e) {
        // ignore
      }
      // Expose Firestore utilities for script.js
      window.db = db;
      window.auth = auth;
      window.authCreate = (email, password) =>
        createUserWithEmailAndPassword(auth, email, password);
      window.authSignIn = (email, password) =>
        signInWithEmailAndPassword(auth, email, password);
      window.authSignOut = () => signOut(auth);
      window.getDoc = getDoc;
      window.doc = doc;
      window.setDoc = setDoc;
      window.runTransaction = runTransaction;
      window.serverTimestamp = serverTimestamp;
      window.collection = collection;
      window.addDoc = addDoc;
      window.getDocs = getDocs;
      window.query = query;
      window.orderBy = orderBy;
      window.limit = limit;
      window.where = where;

      // Load dynamic profanity filter from Firestore
      window.bannedWords = [];

      window.loadBannedWords = async () => {
        try {
          const snap = await getDoc(doc(window.db, "config", "bannedWords"));
          window.bannedWords = snap.exists() ? snap.data().words || [] : [];
          console.info("Loaded banned words:", window.bannedWords);
        } catch (err) {
          console.warn("Failed to load banned words:", err);
          window.bannedWords = [];
        }
      };

      // Promise to indicate when auth is ready
      let authReadyResolve;
      window.leaderboardAuthReady = new Promise((res) => {
        authReadyResolve = res;
      });

      signInAnonymously(auth)
        .then(() => {
          console.info("Anonymous sign-in requested");
        })
        .catch((err) => {
          console.warn("Anonymous sign-in failed:", err);
          if (authReadyResolve) authReadyResolve();
        });

      onAuthStateChanged(auth, (user) => {
        console.info(user ? `Signed in uid=${user.uid}` : "Not signed in");
        if (authReadyResolve) {
          authReadyResolve();
          authReadyResolve = null;
        }
      });

      // Once auth is ready, load the dynamic banned-words list
      window.leaderboardAuthReady
        .then(() => {
          window
            .loadBannedWords?.()
            .catch((err) => console.warn("loadBannedWords failed", err));
        })
        .catch(() => {});

      // Leaderboard API: submit and fetch scores from Firestore
      window.leaderboardApi = {
        async submitScore(testId, name, points) {
          if (!testId) throw new Error("missing testId");
          const col = collection(db, "leaderboards", testId, "scores");
          const docRef = await addDoc(col, {
            name: name || "Anonymous",
            score: Number(points) || 0,
            timestamp: serverTimestamp(),
          });
          return docRef;
        },
        async fetchTopScores(testId, limitNum = 15) {
          if (!testId) throw new Error("missing testId");
          const col = collection(db, "leaderboards", testId, "scores");
          const q = query(col, orderBy("points", "desc"), limit(limitNum));
          const snap = await getDocs(q);
          const out = [];
          snap.forEach((d) => out.push({ id: d.id, ...d.data() }));
          return out;
        },
        async fetchScoresByName(testId, name) {
          if (!testId) throw new Error("missing testId");
          if (!name) throw new Error("missing name");
          const col = collection(db, "leaderboards", testId, "scores");
          const q = query(col, where("name", "==", name));
          const snap = await getDocs(q);
          const out = [];
          snap.forEach((d) => out.push({ id: d.id, ...d.data() }));
          return out;
        },
        async setScoreDoc(testId, docId, data) {
          if (!testId) throw new Error("missing testId");
          if (!docId) throw new Error("missing docId");
          const finalData = { ...data, uid: data.uid || auth.currentUser?.uid };
          await setDoc(
            doc(db, "leaderboards", testId, "scores", docId),
            finalData
          );
          return true;
        },
      };

      // Report submission API
      window.reportApi = {
        async sendIssue({ message, email, page }) {
          if (!message) throw new Error("missing message");
          if (window.leaderboardAuthReady) await window.leaderboardAuthReady;

          const col = collection(db, "reports");
          const docRef = await addDoc(col, {
            message: String(message).slice(0, 2000),
            email: email ? String(email).slice(0, 256) : null,
            page: page || location.pathname || "unknown",
            userAgent: navigator.userAgent || null,
            createdAt: serverTimestamp(),
          });
          return docRef;
        },
      };

      // Account helpers: read/write accounts/{uid}
      window.accounts = {
        async get(uid) {
          if (!uid) throw new Error("missing uid");
          const snap = await getDoc(doc(db, "accounts", uid));
          return snap?.exists() ? snap.data() : null;
        },
        async set(uid, data, options = { merge: true }) {
          if (!uid) throw new Error("missing uid");
          const dref = doc(db, "accounts", uid);
          await setDoc(
            dref,
            data,
            options?.merge ? { merge: true } : undefined
          );
          return true;
        },
      };

      // Convenience logging helper
      window.writeLog = async function (action, context) {
        if (!action) throw new Error("missing action");
        const id = `${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
        const dref = doc(db, "logs", id);
        await setDoc(dref, {
          action,
          context: context || {},
          timestamp: serverTimestamp(),
        });
        return true;
      };
    </script>
  </head>
  <body>
    <h1>FBLACER</h1>
    <!-- Settings cog (opens settings modal which contains dark mode toggle + report form) -->
    <button
      id="settingsBtn"
      aria-label="Open settings"
      title="Settings"
      class="settings-btn"
    >
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="3"></circle>
        <path
          d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24"
        ></path>
      </svg>
    </button>

    <!-- Settings modal (hidden by default) -->
    <div
      id="settingsModal"
      class="settings-modal"
      aria-hidden="true"
      style="
        display: none;
        position: fixed;
        inset: 0;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 99998;
      "
    >
      <div
        class="settings-panel"
        style="
          background: var(--surface, #fff);
          color: var(--text-color, #102027);
          padding: 18px;
          border-radius: 12px;
          min-width: 280px;
          max-width: 520px;
          width: 92%;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
          position: relative;
        "
      >
        <button
          id="settingsClose"
          class="settings-close"
          aria-label="Close"
          style="
            position: absolute;
            right: 20px;
            top: 12px;
            background: none;
            border: none;
            font-size: 20px;
          "
        >
          Ã—
        </button>
        <h3 style="margin-top: 0">Settings</h3>
        <div
          class="settings-section"
          style="
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div style="display: flex; align-items: center; gap: 12px">
            <span id="settingsThemeLabel" style="font-weight: 600"
              >dark/light</span
            >
            <small style="color: var(--muted, #6b7280)">toggle</small>
          </div>
          <label
            class="theme-switch"
            style="display: inline-flex; align-items: center"
          >
            <input
              type="checkbox"
              id="settingsDarkToggle"
              aria-label="Toggle dark mode from settings"
            />
            <span class="slider"></span>
          </label>
        </div>

        <div class="report-section" style="margin-bottom: 6px">
          <h4 style="margin: 6px 0 8px 0">Report an issue</h4>
          <textarea
            id="issueText"
            placeholder="Describe the problem..."
            rows="4"
            class="report-input"
          ></textarea>
          <input
            id="issueEmail"
            placeholder="Email (optional)"
            class="report-input"
          />
          <div class="report-actions">
            <button id="sendIssueBtn">Send report</button>
            <div
              id="reportStatus"
              aria-live="polite"
              class="report-status"
            ></div>
          </div>
        </div>
        <!-- Login / Signup UI -->
        <div
          class="auth-section"
          style="
            margin-top: 12px;
            border-top: 1px dashed rgba(0, 0, 0, 0.06);
            padding-top: 12px;
          "
        >
          <h4 style="margin: 6px 0 8px 0">Login</h4>
          <input
            id="username"
            type="text"
            placeholder="Username"
            class="report-input"
          />
          <input
            id="password"
            type="password"
            placeholder="Password"
            class="report-input"
          />
          <div style="display: flex; gap: 8px; margin-top: 8px">
            <button id="signupBtn">Sign Up</button>
            <button id="loginBtn">Log In</button>
            <button id="logoutBtn" style="display: none">Log Out</button>
          </div>
          <div style="margin-top: 12px">
            <button id="viewProfileBtn">View Public Profile</button>
          </div>
          <div
            id="authStatus"
            style="margin-top: 8px; color: var(--muted, #6b7280)"
          ></div>

          <!-- Legal links -->
          <div
            class="legal-section"
            style="
              margin-top: 14px;
              border-top: 1px dashed rgba(0, 0, 0, 0.06);
              padding-top: 12px;
            "
          >
            <h4 style="margin: 6px 0 8px 0">Legal</h4>
            <div style="display: flex; gap: 8px; align-items: center">
              <button id="openPrivacyBtn">Privacy Policy</button>
              <button id="openTosBtn">Terms of Service</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <select id="testSelect"></select>
    <button id="startBtn" onclick="startTest()">Start Test</button>
    <button id="endBtn" style="display: none">End Test Now</button>

    <div id="flashcard-container"></div>
    <div id="chart-container" style="display: none">
      <canvas id="topicChart"></canvas>
      <div id="topicLegend" class="chart-legend" aria-hidden="false"></div>
    </div>

    <!-- Floating indicators -->
    <div id="floating-container" aria-hidden="true"></div>

    <script src="script.js"></script>
  </body>
</html>
